name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: ['**']
  workflow_dispatch:
    inputs:
      force-publish:
        description: 'Force publish even if no version change was detected'
        required: false
        type: choice
        options:
          - 'true'
          - 'false'
        default: 'false'

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12', '3.13']
        pydantic-version: ['2.11.10', '2.12.5']
        include:
          - python-version: '3.10'
            pydantic-version: '2.12.5'
            is-dev-version: true
            run-expensive-tests: true
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install pydantic~=${{matrix.pydantic-version }} -e .[dev,docs]
      - name: Get Date
        id: get-date
        run: |
          echo "date=$(date +'%Y-%b')"
          echo "date=$(date +'%Y-%b')" >> $GITHUB_OUTPUT
        shell: bash
      - uses: actions/cache/restore@v4
        with:
          path: bioimageio_cache
          key: 'py${{ matrix.python-version }}-${{ steps.get-date.outputs.date }}'
      - name: Check autogenerated imports
        run: python scripts/generate_version_submodule_imports.py check
      - run: ruff check
        if: matrix.is-dev-version
      - run: ruff format
        if: matrix.is-dev-version
      - name: Run Pyright
        if: matrix.is-dev-version
        run: |
          pyright --version
          pyright -p pyproject.toml --pythonversion ${{ matrix.python-version }}
      - run: pytest -v --cov bioimageio --cov-append --capture no
        env:
          BIOIMAGEIO_CACHE_PATH: bioimageio_cache
          RUN_EXPENSIVE_TESTS: ${{ matrix.run-expensive-tests && 'true' || 'false' }}
      - run: pytest -v --cov bioimageio --cov-append --capture no scripts # also test docstrings in scripts for dev-version
        if: ${{matrix.is-dev-version}}
        env:
          BIOIMAGEIO_CACHE_PATH: bioimageio_cache
          RUN_EXPENSIVE_TESTS: ${{ matrix.run-expensive-tests && 'true' || 'false' }}
      - uses: actions/cache/save@v4
        # explicit restore/save instead of cache action to cache even if coverage fails
        with:
          path: bioimageio_cache
          key: 'py${{ matrix.python-version }}-${{ steps.get-date.outputs.date }}'

      - run: cp .coverage .coverage.${{ matrix.python-version }}-${{ matrix.pydantic-version }}
      - uses: actions/upload-artifact@v4
        with:
          name: .coverage.${{ matrix.python-version }}-${{ matrix.pydantic-version }}
          retention-days: 1
          path: .coverage.${{ matrix.python-version }}-${{ matrix.pydantic-version }}
          include-hidden-files: true
  coverage:
    needs: [test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
      - run: |
          pip install coverage
      - uses: actions/download-artifact@v4
        with:
          pattern: .coverage.*
          merge-multiple: true
      - run: |
          ls -la .coverage*
          coverage combine
          coverage xml -o coverage.xml
      - uses: orgoro/coverage@v3.2
        with:
          coverageFile: coverage.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          thresholdAll: 0.7
          thresholdNew: 0.9
          thresholdModified: 0.6
      - name: generate coverage badge and html report
        run: |
          pip install genbadge[coverage]
          genbadge coverage --input-file coverage.xml --output-file ./dist/coverage/coverage-badge.svg
          coverage html -d dist/coverage
      - uses: actions/upload-artifact@v4
        with:
          name: coverage-summary
          retention-days: 1
          path: dist

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v6
        with:
          python-version: '3.10'
          cache: 'pip'
      - name: Install dependencies
        run: pip install build
      - name: Build package
        run: python -m build
      - uses: actions/upload-artifact@v4
        with:
          path: dist/
          name: dist

  conda-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          auto-activate-base: true
          activate-environment: ''
          channel-priority: strict
          miniforge-version: latest
          conda-solver: libmamba
      - name: install common conda dependencies
        run: conda install -n base -c conda-forge conda-build -y
      - uses: actions/cache@v4
        with:
          path: |
            pkgs/noarch
            pkgs/channeldata.json
          key: ${{ github.sha }}-packages
      - name: linux conda build test
        shell: bash -l {0}
        run: |
          mkdir -p ./pkgs/noarch
          conda-build -c conda-forge conda-recipe --output-folder ./pkgs

  #  rattler-build:
  #    name: Build package
  #    runs-on: ubuntu-latest
  #    steps:
  #    - uses: actions/checkout@v4
  #    - name: Build conda package
  #      uses: prefix-dev/rattler-build-action@v0.2.2
  #      with:
  #        recipe-path: conda-recipe/recipe.yaml

  docs:
    needs: [test, coverage, build, conda-build]
    runs-on: ubuntu-latest
    permissions:
      contents: write # required for tag creation
    outputs:
      new-version: ${{ steps.get-new-version.outputs.new-version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
      - uses: ./.github/actions/max_disk_space
      - uses: actions/download-artifact@v4
        with:
          name: coverage-summary
          path: dist
      - uses: actions/setup-python@v6
        with:
          python-version: '3.12'
          cache: 'pip'
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e .[dev,docs]
      - name: Generate spec docs
        run: python scripts/generate_spec_documentation.py --dist dist/user_docs
      - name: Generate interactive documentation
        env:
          PYTHONPATH: './scripts'
        run: python -m interactive_docs
      - name: Generate JSON schema documentation
        run: python scripts/generate_json_schema_documentation.py
      - name: Copy json schema for hosting (bioimageio_schema_latest.json is registered with schemastore.org)
        run: |
          cp src/bioimageio/spec/static/bioimageio_schema.json ./dist/bioimageio_schema_latest.json
      - name: Generate specific JSON schemas
        run: python scripts/generate_specific_json_schemas.py
      - name: copy legacy file until BioImage.IO-packager is updated # TODO: remove if packager does not depend on it anymore
        run: cp weight_formats_spec.json ./dist/weight_formats_spec.json
      - name: Get branch name to deploy to
        id: get_branch
        shell: bash
        run: |
          if [[ -n '${{ github.event.pull_request.head.ref }}' ]]; then branch=gh-pages-${{ github.event.pull_request.head.ref }}; else branch=gh-pages; fi
          echo "::set-output name=branch::$branch"
      - name: Get parent commit
        if: inputs.force-publish != 'true'
        id: get-parent-commit
        run: |
          echo "sha=$(git rev-parse --verify --quiet HEAD^)" >> $GITHUB_OUTPUT
      - id: get-existing-tag
        if: inputs.force-publish == 'true'
        run: echo "existing-tag=$(git tag --points-at HEAD 'v[0-9]*.[0-9]*.[0-9]*')" >> $GITHUB_OUTPUT
      - name: Detect new version from last commit and create tag
        id: tag-version
        if: github.ref == 'refs/heads/main' && steps.get-parent-commit.outputs.sha && inputs.force-publish != 'true'
        uses: salsify/action-detect-and-tag-new-version@v2.0.3
        with:
          create-tag: true
          version-command: |
            python -c "from pathlib import Path;print(Path('src/bioimageio/spec/_version.py').read_text().split('VERSION = \"')[1].split('\"')[0])"
      - shell: python
        id: get-new-version
        run: |
          import os
          from pathlib import Path

          if "${{ inputs.force-publish }}" == "true":
              existing_tag = "${{ steps.get-existing-tag.outputs.existing-tag }}"
              valid = existing_tag.count("v") == 1 and existing_tag.count(".") == 3 and all(part.isdigit() for part in existing_tag.lstrip("v").split("."))
              if not valid:
                  raise Exception(f"Current commit has invalid version tag {existing_tag}")

              source_version = Path('src/bioimageio/spec/_version.py').read_text().split('VERSION = \"')[1].split('\"')[0]
              if existing_tag != f"v{source_version}":
                  raise Exception(f"Version tag {existing_tag} does not match source version {source_version}")

              new_version = existing_tag
          else:
              new_version = "${{ steps.tag-version.outputs.tag }}"

          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              print(f"new-version={new_version}", file=f)

      - name: Configure Git Credentials
        run: |
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com
      - name: Generate developer docs
        run: mike deploy --push --branch ${{ steps.get_branch.outputs.branch }} --update-aliases ${{ steps.get-new-version.outputs.new-version || 'dev'}} ${{ steps.get-new-version.outputs.new-version && 'latest' || ' '}}
      - name: Deploy additional files to ${{ steps.get_branch.outputs.branch }} ðŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: ${{ steps.get_branch.outputs.branch }}
          folder: dist
          clean: true
          clean-exclude: |
            .nojekyll
            index.html
            versions.json
            dev/
            latest/
            v0.*/

  publish:
    needs: [test, coverage, build, conda-build, docs]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && needs.docs.outputs.new-version
    environment:
      name: release
      url: https://pypi.org/project/bioimageio.spec/
    permissions:
      contents: write # required to create a github release (release drafter)
      id-token: write # required for pypi publish action
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist
      - name: Publish package on PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
      - name: Publish the release notes
        uses: release-drafter/release-drafter@v6.0.0
        with:
          tag: '${{ needs.docs.outputs.new-version }}'
        env:
          GITHUB_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
